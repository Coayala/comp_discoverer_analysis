---
title: "Normalization and Statistical Analysis"
author: "Christian Ayala"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

This Notebook is to perform normalization of the area under the curve (AUC) of the peaks detected by *Compound Discoverer*.

# 1. Importing Libraries

```{r libraries, message=FALSE}
library(tidyverse)
library(readxl)
library(ggpubr)
library(ggsci)
library(gridExtra)
library(vegan)
library(factoextra)
source('functions_cdis_norm_stats.R')
```

# 2. Import data

The input data is the **compounds-table** generated by the previous scripts

```{r set_path, message=FALSE}
# set path variables
project_dir <- getwd()
project_name <- 'Bog_labeled_1.7int'
figures_dir <- file.path(project_dir, paste0(project_name, '_output_figures'))
tables_dir <- file.path(project_dir,  paste0(project_name, '_output_tables'))
compounds_table_file <- file.path(tables_dir, 'compounds_table.csv')

# Load compounds_table

compounds_table <- read_csv(compounds_table_file)

# Import metadata and fix names
metadata_file <- file.path(tables_dir, 'fixed_metadata.csv')
metadata <- read_csv(metadata_file)

```

# 3. Data Manipulation and Transformation

```{r Data_manipulation}
# Create a new tibble with the AUC per each mass from each sample
auc_table <- compounds_table %>% 
  select(FeatureID, SampleID, AUC)

# Transform the dataframe into a matrix-like table

auc_table <-  spread(auc_table, SampleID, AUC)
auc_table$FeatureID <- factor(auc_table$FeatureID, levels = str_sort(auc_table$FeatureID, numeric = TRUE))
auc_table <- auc_table %>% 
  arrange(FeatureID)


# Save untransformed data

auc_table <- column_to_rownames(auc_table, var = 'FeatureID')

table_file <- file.path(tables_dir, 'raw_auc_table.csv')
write.csv(auc_table, table_file, row.names = TRUE)

```

# 4. Data Normalization by multiple methods

Data is normalized by multiple methods to decide

```{r Data_normalization}

normalization_plot <- normalize_by_all(auc_table)

figure_file <- file.path(figures_dir, 'all_normalized.boxplot.png')
ggsave(figure_file, normalization_plot, dpi = 300)

```

Based on the plot select the best normalization method for the sample.
In this case the best normalization method was **LOESS normalization**


```{r Best normalization}

norm.matrix <- cycloess.norm(auc_table)

```

# 5. Statistical Analysis

## 5.1 NMDS 

Choose if analysis will be done based on relative abundance or presence absence

```{r typeofanalysis}

# This portion of the script cwas adapted from statistical analysis from MetaboTandem and MetaboDirect pipelines

# Change missing values for zeroes

norm.matrix[is.na(norm.matrix)] <- 0

type <- 'ra'

if(type == 'ra'){
  nmds.matrix <- t(norm.matrix)
  dm.method <- 'bray'
  # distance matrix by Bray because relative abundance mode was selected
  dm <- vegdist(nmds.matrix, method=dm.method)
}else if(type == 'pa'){
  nmds.matrix <- decostand(t(norm.matrix), type)
  dm.method <- 'euclidean'
  dm <- vegdist(nmds.matrix, method = dm.method)
} else{
  print('Select analysis method: "pa" for presence absence or "ra" for relative abundance')
}

```

Perform the actual nmds analysis

**A good rule of thumb for interpretation**: 
- < 0.05 provides an excellent representation in reduced dimensions, 
- < 0.1 is great, 
- < 0.2 is good/ok, 
- < 0.3 provides a poor representation. 


```{r nmds}

set.seed(123)
nmds <- metaMDS(dm,
                k = 2,
                maxit = 999,
                trymax = 500,
                wascores = TRUE)
stressplot(nmds)

# Extract nmds scores for plotting

nmds.scores <- as.data.frame(scores(nmds))
nmds.scores <- rownames_to_column(nmds.scores, var = 'SampleID')
nmds.scores <- left_join(nmds.scores, metadata, by = 'SampleID')

nmds_plot <- plot_nmds(nmds.scores, Time, Label)
nmds_plot <- nmds_plot +
  labs(title = 'NMDS plot by relative abundance')
nmds_plot

figure_file <- file.path(figures_dir, 'nmds_relative_abundance.png')
ggsave(figure_file, nmds_plot, dpi = 300)

```

## 5.2 PCA

```{r}

```



## 5.3 PERMANOVA

Permutational Multivariate Analysis of Variance Using Distance Matrices

```{r Permanova}

rownames(metadata) <- metadata$SampleID

set.seed(456)
permanova <- adonis(dm ~ Time + Material + Label, 
                    data=metadata, 
                    permutations=999, 
                    method="bray")
permanova


```

The permanova shows that AUC at **different time points** contribute to 56% of the differences among the samples

## 5.4 Feature contribution

Explore to determine which features are driving the difference in time

```{r Feature contribution}

# Comparisons are done in pairs

# Comparing based on the sample origin (litter or peat_litter)

sub_metadata <- metadata %>% 
  filter(Time == 'T0' | Time == 'T3')

sub_norm.matrix <- select(norm.matrix, rownames(sub_metadata))

test <- 'Time'
set.seed(456)
# LEAFLIFE; adonis tests homogeneity of dispersion among groups
p.Time <- adonis(t(sub_norm.matrix) ~ Time, 
                data=sub_metadata, 
                permutations=999, 
                method="bray")
p.Time

p.Time.features <- coefficients(p.Time)['Time1',]
p.Time.features <- p.Time.features[rev(order(abs(p.Time.features )))]
p.Time.features <- as.data.frame(p.Time.features) 
colnames(p.Time.features) <- paste0(test, '.f.contrib')
p.Time.features <- signif(p.Time.features, 2)
p.Time.features$Features <- rownames(p.Time.features) #NEGATIVE = Drives T3, POSITIVE = Drives T0


t2 = quantile(abs(p.Time.features$Time.f.contrib), 0.60)
t2
p.Time.features.g <- mutate(p.Time.features,
                            Group = if_else(abs(Time.f.contrib)<t2, 'low contribution',
                                                if_else(Time.f.contrib>t2, 'T0', 'T3')))

file_table <- (file.path(tables_dir, 'features_contribution_T0vsT3.csv'))
write_csv(p.Time.features.g, file_table)
Time.contrib <- 
  p.Time.features.g %>% 
  filter(abs(Time.f.contrib)>t2) %>% 
  ggplot(aes(x = reorder(Features, Time.f.contrib), y = Time.f.contrib, fill = Time.f.contrib > 0)) +
    geom_bar(stat="identity", width = 1, color='black', size=0.1, alpha=0.6) +
    scale_fill_jama(labels = c('T3', 'T0')) +
  theme_bw() +
  labs(title = 'Feature contribution to the difference observed at different times',
       x = 'MS Features',
       y = 'Contribution',
       fill = 'Drives:') +
  theme(plot.title = element_text(face = 'bold',
                                  hjust = 0.5),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
  

Time.contrib

figure_file <- file.path(figures_dir, 'Contribution in time.png')
ggsave(figure_file, Time.contrib, dpi = 300)

```

```{r}
neg.features <- p.Time.features.g %>% 
  slice_min(Time.f.contrib, n = 10)

neg.features <- left_join(neg.features, compounds_table, by = c('Features' = 'FeatureID')) %>% 
  select(Time.f.contrib, Features, Name, Formula) %>% 
  distinct()

pos.features <- p.Time.features.g %>% 
  slice_max(Time.f.contrib, n = 10)

pos.features <- left_join(pos.features, compounds_table, by = c('Features' = 'FeatureID')) %>% 
  select(Time.f.contrib, Features, Name, Formula) %>% 
  distinct()


```


