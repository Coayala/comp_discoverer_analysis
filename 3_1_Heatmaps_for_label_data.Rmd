---
title: "3_DIfferential Analysis"
author: "Christian Ayala"
date: "3/19/2021"
output: html_document
---

This Notebook is to perform the differential analysis of the normalized AUC from *Compound Discoverer*.

# 1. Importing Libraries

```{r libraries, message=FALSE}
library(tidyverse)
library(ggpubr)
library(ggsci)
library(ggrepel)
library(pheatmap)
library(RColorBrewer)
source('functions_cdis_diff.R')
```

# 2. Import data

Because differential analysis includes the calculations of means, the data to be used in this section is the normalized untransformed data

```{r set_path, message=FALSE}
# set path variables
project_dir <- getwd()
project_name <- 'Bog_lbl_unlbl_1.7int'
figures_dir <- file.path(project_dir, paste0(project_name, '_output_figures'))
tables_dir <- file.path(project_dir,  paste0(project_name, '_output_tables'))
norm_auc_table_file <- file.path(tables_dir, 'normalized_untransformed_auc_table.csv')
compounds_table_file <- file.path(tables_dir, 'compounds_table.csv' )

# Load compounds_table

norm.matrix <- read_csv(norm_auc_table_file)
norm.matrix <- column_to_rownames(norm.matrix, var = 'X1')

compounds_table <- read_csv(compounds_table_file)

# Import metadata and fix names
metadata_file <- file.path(tables_dir, 'fixed_metadata.csv')
metadata <- read_csv(metadata_file)

```

# 3. Calculate ratios and log2fold-change

Because this set of samples does not have replicates for all the treatments, no pvalue is going to be calculated. Because labeled analysis does not fill gaps, log2FC cannot be calculated for all features. Thus, this section will be skipped and no volcano plots will be plotted.

## 3.1 Get samples based on label

## 3.2 Get table of differentially expressed features per each comparison


# 4.Hierarchical clustering

## 4.1 Unlabeled samples

```{r}

unlabeled_metadata <- metadata %>% 
  filter(Label == 'Sample')

# Set sampleID as row.names to annotate heatmap

colData <- column_to_rownames(unlabeled_metadata, var = 'SampleID') %>% 
  select(-Label)

# A subset of the AUC is used that contains only the selected samples
sub.norm.matrix <- norm.matrix %>% 
  select(unlabeled_metadata$SampleID)

# Because data has too many zeros, those features were removed
sub.norm.matrix <- sub.norm.matrix[apply(sub.norm.matrix!=0, 1, all),]

mapcolor <- colorRampPalette(brewer.pal(11, 'RdYlBu'))(100)[100:1]

annot_colors <- list(
  Time = c(T0 ='#0073C2FF', T1 = '#EFC000FF', T2 = '#868686FF', T3 = '#CD534CFF'),
  Material = c(Litter = 'green4', Litter_Peat = 'chocolate4')
)

figure_file <- file.path(figures_dir, 'All_features_HTMP_unlabel.pdf')

pdf(figure_file)
pheatmap(sub.norm.matrix,
         clustering_distance_rows = 'correlation',
         clustering_distance_cols = 'correlation',
         scale = 'row',
         annotation_col = colData,
         annotation_colors = annot_colors,
         color = mapcolor,
         show_rownames = FALSE,
         cutree_cols = 3,
         cutree_rows = 4,
         main = 'Heatmap normalized AUC (Unlabeled samples)'
         )
dev.off()

```

## 4.2 Labeled samples

```{r}

labeled_metadata <- metadata %>% 
  filter(Label == 'Labeled')

# Set sampleID as row.names to annotate heatmap

colData <- column_to_rownames(labeled_metadata, var = 'SampleID') %>% 
  select(-Label)

# A subset of the AUC is used that contains only the selected samples
sub.norm.matrix <- norm.matrix %>% 
  select(labeled_metadata$SampleID)

# Because data has too many zeros, those samples were removed
sub.norm.matrix <- sub.norm.matrix[apply(sub.norm.matrix!=0, 1, all),]

mapcolor <- colorRampPalette(brewer.pal(11, 'RdYlBu'))(100)[100:1]

figure_file <- file.path(figures_dir, 'All_features_HTMP_label.png')

png(figure_file)
pheatmap(sub.norm.matrix,
         clustering_distance_rows = 'correlation',
         clustering_distance_cols = 'correlation',
         scale = 'row',
         annotation_col = colData,
         color = mapcolor,
         show_rownames = FALSE,
         cutree_cols = 3,
         main = 'Heatmap normalized AUC (Labeled samples)'
         )
dev.off()

```


